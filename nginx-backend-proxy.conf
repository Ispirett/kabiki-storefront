# Nginx Configuration for Medusa Backend Proxy
# This allows your backend to be accessible via a subdomain or path

# ============================================
# OPTION 1: Subdomain (RECOMMENDED)
# ============================================
# Setup: api.kabiki.com -> localhost:9000

server {
    listen 80;
    server_name api.kabiki.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.kabiki.com;

    # SSL Certificate (use certbot to get free SSL)
    ssl_certificate /etc/letsencrypt/live/api.kabiki.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.kabiki.com/privkey.pem;

    # Proxy to Medusa backend
    location / {
        proxy_pass http://localhost:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Increase timeouts for large uploads
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    }
}

# ============================================
# OPTION 2: Path on Main Domain
# ============================================
# Setup: kabiki.com/api -> localhost:9000
# Add this to your existing kabiki.com server block:

# server {
#     listen 443 ssl http2;
#     server_name kabiki.com www.kabiki.com;
#     
#     # ... your existing SSL config ...
#     
#     # Proxy /api to Medusa backend
#     location /api/ {
#         proxy_pass http://localhost:9000/;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }
#     
#     # Your Next.js frontend
#     location / {
#         proxy_pass http://localhost:3000;
#         # ... rest of your frontend config ...
#     }
# }

# ============================================
# SETUP INSTRUCTIONS
# ============================================

# 1. Choose Option 1 (subdomain) or Option 2 (path)

# 2. For Option 1 (subdomain):
#    a. Add DNS A record: api.kabiki.com -> Your Server IP
#    b. Copy this config to: /etc/nginx/sites-available/api-kabiki
#    c. Create symlink: sudo ln -s /etc/nginx/sites-available/api-kabiki /etc/nginx/sites-enabled/
#    d. Get SSL certificate: sudo certbot --nginx -d api.kabiki.com
#    e. Test nginx: sudo nginx -t
#    f. Reload nginx: sudo systemctl reload nginx

# 3. For Option 2 (path):
#    a. Add the location /api/ block to your existing nginx config
#    b. Test nginx: sudo nginx -t
#    c. Reload nginx: sudo systemctl reload nginx

# 4. Update .env.production with the correct URL

# 5. Update Medusa CORS settings in medusa-config.js:
#    storeCors: "https://kabiki.com,https://www.kabiki.com"

# 6. Rebuild and restart your storefront:
#    npm run build
#    pm2 restart kabiki-storefront
